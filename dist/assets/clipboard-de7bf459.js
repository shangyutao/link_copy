import{S as q,r as k,c as E}from"./vendor-0fdb20b8.js";import{a as Y}from"./utils-917b1704.js";import{c as Q,d as _,s as $}from"./vant-b07c73d6.js";const ee=!1,B={}.VITE_API_BASE_URL||"/api";console.log("APIç¯å¢ƒé…ç½®:",{isDevelopment:ee,API_BASE_URL:B});const p=Y.create({baseURL:B,timeout:3e4,headers:{"Content-Type":"application/json"}});p.interceptors.request.use(e=>{var t;e.showLoading!==!1&&Q({message:"è¯·æ±‚ä¸­...",forbidClick:!0,duration:0});try{e.data instanceof FormData&&e.headers&&(delete e.headers["Content-Type"],delete e.headers["content-type"])}catch{}return console.log("APIè¯·æ±‚:",(t=e.method)==null?void 0:t.toUpperCase(),e.url,e.data),e},e=>(_(),console.error("è¯·æ±‚é”™è¯¯:",e),Promise.reject(e)));p.interceptors.response.use(e=>{_();const{data:t}=e;if(console.log("APIå“åº”:",e.config.url,t),t.code&&t.code!==200){const a=t.message||"è¯·æ±‚å¤±è´¥";return $({type:"fail",message:a}),Promise.reject(new Error(a))}return t},e=>{_(),console.error("å“åº”é”™è¯¯:",e);let t="ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•";if(e.response){const{status:a,data:n}=e.response;switch(a){case 400:t=n.message||"è¯·æ±‚å‚æ•°é”™è¯¯";break;case 401:t="æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•";break;case 403:t="æ²¡æœ‰æƒé™è®¿é—®";break;case 404:t="è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨";break;case 408:t="è¯·æ±‚è¶…æ—¶";break;case 500:t="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯";break;case 503:t="æœåŠ¡æš‚æ—¶ä¸å¯ç”¨";break;default:n&&n.message&&(t=n.message)}}else e.code==="ECONNABORTED"?t="è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥":e.message==="Network Error"&&(t="ç½‘ç»œè¿æ¥å¼‚å¸¸");return $({type:"fail",message:t}),Promise.reject(e)});var P;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(P||(P={}));var V;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(V||(V={}));async function te(e,t=20*1024*1024){if(!e)throw new Error("æ— æ•ˆæ–‡ä»¶");return console.log("âš ï¸ å‹ç¼©åŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼Œç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶"),console.log("ğŸ“ åŸå› ï¼šFFmpeg æ ¸å¿ƒæ–‡ä»¶åŠ è½½å¤±è´¥"),console.log("ğŸ’¡ å»ºè®®ï¼šæ–‡ä»¶å¤§å°è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè¯·æ‰‹åŠ¨å‹ç¼©åå†ä¸Šä¼ "),console.log("ğŸ“Š æ–‡ä»¶ä¿¡æ¯:",{name:e.name,size:(e.size/(1024*1024)).toFixed(2)+"MB",threshold:(t/(1024*1024)).toFixed(2)+"MB"}),{file:e,compressed:!1}}const w={async createDownloadTask(e,t=null){return(await p.post("/video/download",{url:e,platform:t})).data},async uploadVideoFile(e,t=null){var D,R,L,y;if(!e||!(e instanceof File))throw new Error("è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶");const a=500*1024*1024;if(e.size>a)throw new Error(`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡500MBï¼Œå½“å‰æ–‡ä»¶å¤§å°ï¼š${this.formatFileSize(e.size)}`);const n=["video/mp4","video/avi","video/quicktime","video/x-msvideo","video/x-flv","video/webm","video/x-matroska","video/mp4v-es","video/3gpp","video/ogg"],h=[".mp4",".avi",".mov",".wmv",".flv",".webm",".mkv",".m4v",".3gp",".ogv"],i=e.name.toLowerCase().substring(e.name.lastIndexOf("."));if(!n.includes(e.type)&&!h.includes(i))throw new Error("ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼ï¼Œè¯·ä¸Šä¼  MP4ã€AVIã€MOVã€WMVã€FLVã€WEBMã€MKVã€M4Vã€3GPã€OGV æ ¼å¼çš„è§†é¢‘æ–‡ä»¶");let v=e;const u={}.VITE_ENABLE_UPLOAD_COMPRESSION!=="false",d=Number({}.VITE_UPLOAD_COMPRESSION_THRESHOLD_MB||20),l=Math.max(1,d)*1024*1024;if(u&&e.size>l){console.log("ğŸ”§ è§¦å‘å‹ç¼©é€»è¾‘:",{fileSize:e.size,thresholdBytes:l,enableCompression:u,isDev:!1});try{te(e,l).then(({file:c,compressed:I})=>{if(I){console.log("âœ… åå°å‹ç¼©å®Œæˆï¼Œä¸‹æ¬¡ä¸Šä¼ å°†ä½¿ç”¨å‹ç¼©ç‰ˆæœ¬:",{originalSize:e.size,newSize:c.size,reduction:Math.round((1-c.size/e.size)*100)+"%"});try{const g=`compressed_${e.name}_${e.size}`;localStorage.setItem(g,JSON.stringify({name:c.name,size:c.size,timestamp:Date.now()}))}catch(g){console.warn("å­˜å‚¨å‹ç¼©ä¿¡æ¯å¤±è´¥:",g)}}else console.log("âš ï¸ å‹ç¼©æœªç”Ÿæ•ˆï¼Œæ–‡ä»¶å¤§å°æœªè¶…è¿‡é˜ˆå€¼æˆ–å‹ç¼©å¤±è´¥")}).catch(c=>{console.warn("âŒ åå°å‹ç¼©å¤±è´¥:",c)})}catch(c){console.warn("âŒ å¯åŠ¨åå°å‹ç¼©å¤±è´¥:",c)}}else console.log("â„¹ï¸ è·³è¿‡å‹ç¼©:",{enableCompression:u,fileSize:e.size,thresholdBytes:l,reason:u?"æ–‡ä»¶æœªè¶…è¿‡é˜ˆå€¼":"å‹ç¼©å·²ç¦ç”¨"});v=e;const m=new FormData;m.append("video",v);const S={timeout:3e5,onUploadProgress:c=>{if(t&&c.total){const I=Math.round(c.loaded*100/c.total);t(I)}}};try{return(await p.post("/video/upload",m,S)).data}catch(c){throw(D=c==null?void 0:c.response)==null||D.status,(L=(R=c==null?void 0:c.response)==null?void 0:R.data)!=null&&L.message,c.code==="ECONNABORTED"?new Error("ä¸Šä¼ è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä¸Šä¼ æ›´å°çš„æ–‡ä»¶"):((y=c.response)==null?void 0:y.status)===413?new Error("æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº500MBçš„è§†é¢‘æ–‡ä»¶"):c}},async getTaskStatus(e){return(await p.get(`/video/status/${e}`,{showLoading:!1})).data},async getDownloadUrl(e){return`${p.defaults.baseURL}/video/file/${e}`},async cleanVideo(e){return(await p.delete(`/video/clean/${e}`,{showLoading:!1})).data},async deleteTask(e){return this.cleanVideo(e)},async getSupportedPlatforms(){return(await p.get("/video/platforms")).data},async getTaskList(e={}){return(await p.get("/video/tasks",{params:e})).data},async getStats(){return(await p.get("/video/stats")).data},async cleanExpiredFiles(e=24){return(await p.post("/video/clean/expired",{hours:e})).data},async retryTask(e){return(await p.post(`/video/retry/${e}`)).data},async getVideoPreview(e){return await p.get(`/video/preview/${e}`)},async transcribeVideo(e){return(await p.post(`/video/transcribe/${e}`)).data},async optimizeText(e,t={}){var v;if(!e||typeof e!="string")throw new Error("æ–‡æ¡ˆå†…å®¹ä¸èƒ½ä¸ºç©º");const a=e.trim();if(a.length===0)throw new Error("æ–‡æ¡ˆå†…å®¹ä¸èƒ½ä¸ºç©º");const n=1e4;if(a.length>n)throw new Error(`æ–‡æ¡ˆé•¿åº¦ä¸èƒ½è¶…è¿‡${n}å­—ç¬¦ï¼Œå½“å‰é•¿åº¦ï¼š${a.length}`);const h=t.timeout||12e4,i=1500;if(a.length>i)return await this._optimizeTextInChunks(a,h);try{return(await p.post("/video/optimize-text",{text:a},{timeout:h,showLoading:t.showLoading!==!1})).data}catch(u){throw u.code==="ECONNABORTED"||((v=u.response)==null?void 0:v.status)===408?new Error("AIä¼˜åŒ–è¯·æ±‚è¶…æ—¶ï¼Œå»ºè®®å°†é•¿æ–‡æ¡ˆåˆ†æ®µæäº¤"):u}},async _optimizeTextInChunks(e,t){const n=[],h=e.split(/([ã€‚ï¼ï¼Ÿ\.\!\?]+)/);let i="";for(let l=0;l<h.length;l++){const m=h[l];i.length+m.length<=1500?i+=m:(i.trim()&&n.push(i.trim()),i=m)}if(i.trim()&&n.push(i.trim()),n.length===1&&n[0].length>1500){n.length=0;for(let l=0;l<e.length;l+=1500)n.push(e.slice(l,l+1500))}console.log(`æ–‡æ¡ˆåˆ†ä¸º${n.length}æ®µè¿›è¡Œä¼˜åŒ–`);const v=[],u=[];for(let l=0;l<n.length;l++)try{console.log(`æ­£åœ¨ä¼˜åŒ–ç¬¬${l+1}/${n.length}æ®µ...`);const m=await p.post("/video/optimize-text",{text:n[l]},{timeout:t,showLoading:!1});v.push(m.data.optimizedText||n[l]),l<n.length-1&&await new Promise(S=>setTimeout(S,1e3))}catch(m){console.error(`ç¬¬${l+1}æ®µä¼˜åŒ–å¤±è´¥:`,m),u.push(`ç¬¬${l+1}æ®µ: ${m.message}`),v.push(n[l])}const d=v.join("");return{originalText:e,optimizedText:d,optimizationTime:new Date().toISOString(),model:"doubao-seed-1-6-250615",chunks:n.length,errors:u.length>0?u:void 0}},async getTranscriptionResult(e){return(await p.get(`/video/transcription/${e}`,{showLoading:!1})).data},async pollTranscriptionResult(e,{interval:t=3e3,maxAttempts:a=100}={}){var h,i,v,u;let n=0;for(;n<a;){try{const d=await this.getTranscriptionResult(e);if(d.status==="completed"||((h=d.transcription)==null?void 0:h.status)==="completed")return d;if(d.status==="failed"||((i=d.transcription)==null?void 0:i.status)==="failed")throw new Error(d.errorMessage||((v=d.transcription)==null?void 0:v.errorMessage)||"è½¬æ–‡æ¡ˆå¤±è´¥")}catch(d){if(((u=d==null?void 0:d.response)==null?void 0:u.status)!==404)throw d}await new Promise(d=>setTimeout(d,t)),n++}throw new Error("è½¬æ–‡æ¡ˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")}};class re{constructor(){this.currentTaskId=null,this.shouldCleanOnUnload=!0,this.setupCleanupListeners()}setCurrentTask(t){this.currentTaskId&&this.currentTaskId!==t&&this.cleanTask(this.currentTaskId),this.currentTaskId=t}async cleanTask(t){if(t)try{await w.cleanVideo(t),console.log(`å·²æ¸…ç†è§†é¢‘ç¼“å­˜: ${t}`)}catch(a){console.warn(`æ¸…ç†è§†é¢‘ç¼“å­˜å¤±è´¥: ${t}`,a)}}async cleanCurrentTask(){this.currentTaskId&&(await this.cleanTask(this.currentTaskId),this.currentTaskId=null)}setShouldCleanOnUnload(t){this.shouldCleanOnUnload=t}setupCleanupListeners(){window.addEventListener("beforeunload",()=>{if(this.shouldCleanOnUnload&&this.currentTaskId){const t=`${p.defaults.baseURL}/video/clean/${this.currentTaskId}`;navigator.sendBeacon(t,JSON.stringify({method:"DELETE"}))}}),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"&&this.shouldCleanOnUnload&&this.currentTaskId){const t=`${p.defaults.baseURL}/video/clean/${this.currentTaskId}`;navigator.sendBeacon(t,JSON.stringify({method:"DELETE"}))}}),window.addEventListener("pagehide",()=>{if(this.shouldCleanOnUnload&&this.currentTaskId){const t=`${p.defaults.baseURL}/video/clean/${this.currentTaskId}`;navigator.sendBeacon(t,JSON.stringify({method:"DELETE"}))}})}}const C=new re,f={get(e,t=null){try{const a=localStorage.getItem(e);return a?JSON.parse(a):t}catch(a){return console.error("è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:",a),t}},set(e,t){try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(a){return console.error("ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:",a),!1}},remove(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("åˆ é™¤æœ¬åœ°å­˜å‚¨å¤±è´¥:",t),!1}},clear(){try{return localStorage.clear(),!0}catch(e){return console.error("æ¸…ç©ºæœ¬åœ°å­˜å‚¨å¤±è´¥:",e),!1}},getSize(){try{let e=0;for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=localStorage[t].length+t.length);return e}catch(e){return console.error("è®¡ç®—å­˜å‚¨å¤§å°å¤±è´¥:",e),0}}},le=q("task",()=>{const e=k(null),t=k([]),a=k(!1),n=k(!1),h=k(null),i=k(null),v=E(()=>{var r;return((r=e.value)==null?void 0:r.progress)||0}),u=E(()=>{var s;const r=(s=e.value)==null?void 0:s.status;return r==="pending"||r==="downloading"}),d=E(()=>{var r;return((r=e.value)==null?void 0:r.status)==="completed"}),l=E(()=>{var r;return((r=e.value)==null?void 0:r.status)==="failed"}),m=E(()=>{var r;return((r=i.value)==null?void 0:r.status)==="processing"}),S=E(()=>{var r;return((r=i.value)==null?void 0:r.status)==="completed"}),D=E(()=>{var r;return((r=i.value)==null?void 0:r.status)==="failed"}),R=async(r,s=null)=>{a.value=!0;try{await x();const o=await w.createDownloadTask(r,s);return e.value={taskId:o.taskId,originalUrl:r,platform:o.platform,status:o.status,progress:0,createTime:o.createTime,isExisting:o.isExisting},C.setCurrentTask(o.taskId),await O(e.value),N(e.value),u.value&&g(o.taskId),o}catch(o){throw console.error("åˆ›å»ºä»»åŠ¡å¤±è´¥:",o),o}finally{a.value=!1}},L=async(r,s=null)=>{a.value=!0;try{await x();const o=await w.uploadVideoFile(r,s);e.value={taskId:o.taskId,originalFile:r,fileName:r.name,fileSize:r.size,platform:"upload",status:o.status,progress:0,createTime:o.createTime||new Date().toISOString(),isExisting:o.isExisting||!1},C.setCurrentTask(o.taskId);const A={...e.value,originalFile:null};return await O(A),N(A),u.value&&g(o.taskId),o}catch(o){throw console.error("åˆ›å»ºä¸Šä¼ ä»»åŠ¡å¤±è´¥:",o),o}finally{a.value=!1}},y=async r=>{try{const s=await w.getTaskStatus(r);console.log("APIè¿”å›çš„ä»»åŠ¡çŠ¶æ€:",s);const o=s.data||s;return console.log("æå–çš„ä»»åŠ¡æ•°æ®:",o),console.log("ä»»åŠ¡è¿›åº¦:",o.progress),e.value&&e.value.taskId===r?(e.value={...e.value,...o,updateTime:new Date().toISOString()},console.log("æ›´æ–°åçš„ä»»åŠ¡çŠ¶æ€:",e.value),await O(e.value),z(e.value)):e.value||(e.value={...o,updateTime:new Date().toISOString()},console.log("åˆ›å»ºçš„å½“å‰ä»»åŠ¡:",e.value),await O(e.value),N(e.value)),s}catch(s){throw console.error("åˆ·æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:",s),s}},c=async()=>{var r;if((r=e.value)!=null&&r.taskId)return await y(e.value.taskId)},I=r=>{e.value&&(e.value={...e.value,...r,updateTime:new Date().toISOString()},O(e.value),z(e.value))},g=r=>{T(),h.value=setInterval(async()=>{try{await y(r),u.value||T()}catch(s){console.error("è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:",s),T()}},5e3)},T=()=>{h.value&&(clearInterval(h.value),h.value=null)},H=async r=>{n.value=!0;try{const s=await w.getDownloadUrl(r),o=document.createElement("a");return o.href=s,o.download=`video_${r}.mp4`,document.body.appendChild(o),o.click(),document.body.removeChild(o),!0}catch(s){throw console.error("ä¸‹è½½è§†é¢‘å¤±è´¥:",s),s}finally{n.value=!1}},M=async r=>{try{i.value={taskId:r,status:"processing",progress:0,createTime:new Date().toISOString()},await w.transcribeVideo(r);const s=await w.pollTranscriptionResult(r);return i.value={...i.value,...s,status:"completed"},s}catch(s){throw i.value&&(i.value.status="failed",i.value.errorMessage=s.message),console.error("è½¬æ¢è§†é¢‘ä¸ºæ–‡æ¡ˆå¤±è´¥:",s),s}},K=async r=>{try{const s=await w.getTranscriptionResult(r);return i.value={...i.value,...s.transcription,videoInfo:s.videoInfo},s}catch(s){throw console.error("è·å–è½¬æ–‡æ¡ˆç»“æœå¤±è´¥:",s),s}},W=async(r,s={})=>{try{return await w.optimizeText(r,s)}catch(o){throw console.error("AIä¼˜åŒ–æ–‡æ¡ˆå¤±è´¥:",o),o}},x=async()=>{if(e.value)try{await C.cleanCurrentTask(),console.log("å·²æ¸…ç†å½“å‰ä»»åŠ¡ç¼“å­˜")}catch(r){console.warn("æ¸…ç†å½“å‰ä»»åŠ¡å¤±è´¥:",r)}},b=async r=>{try{return await w.cleanVideo(r),e.value&&e.value.taskId===r&&(e.value=null,C.setCurrentTask(null),T()),j(r),await F(r),!0}catch(s){throw console.error("å–æ¶ˆä»»åŠ¡å¤±è´¥:",s),s}},G=async r=>b(r),Z=async r=>{try{const s=await w.retryTask(r);return e.value&&e.value.taskId===r&&(e.value.status="pending",g(r)),s}catch(s){throw console.error("é‡è¯•ä»»åŠ¡å¤±è´¥:",s),s}},J=()=>{e.value=null,i.value=null,T(),C.setCurrentTask(null)},U=async()=>{try{const r=f.get("taskHistory",[]);return t.value=r,r}catch(r){return console.error("åŠ è½½ä»»åŠ¡å†å²å¤±è´¥:",r),[]}},X=async()=>{try{return t.value=[],f.remove("taskHistory"),!0}catch(r){throw console.error("æ¸…é™¤å†å²è®°å½•å¤±è´¥:",r),r}},N=r=>{const s=t.value.findIndex(o=>o.taskId===r.taskId);s>=0?t.value[s]={...r,updateTime:new Date().toISOString()}:(t.value.unshift({...r,updateTime:new Date().toISOString()}),t.value.length>50&&(t.value=t.value.slice(0,50))),f.set("taskHistory",t.value)},z=r=>{const s=t.value.findIndex(o=>o.taskId===r.taskId);s>=0&&(t.value[s]={...r,updateTime:new Date().toISOString()},f.set("taskHistory",t.value))},j=r=>{t.value=t.value.filter(s=>s.taskId!==r),f.set("taskHistory",t.value)},O=async r=>{try{f.set(`task_${r.taskId}`,r)}catch(s){console.error("ä¿å­˜ä»»åŠ¡åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:",s)}},F=async r=>{try{f.remove(`task_${r}`)}catch(s){console.error("ä»æœ¬åœ°å­˜å‚¨ç§»é™¤ä»»åŠ¡å¤±è´¥:",s)}};return{currentTask:e,taskHistory:t,isLoading:a,isDownloading:n,transcriptionData:i,currentProgress:v,isProcessing:u,isCompleted:d,isFailed:l,isTranscribing:m,isTranscriptionCompleted:S,isTranscriptionFailed:D,createTask:R,createUploadTask:L,refreshTaskStatus:y,updateTaskStatus:c,updateCurrentTask:I,startPolling:g,stopPolling:T,downloadVideo:H,transcribeVideo:M,getTranscriptionResult:K,optimizeText:W,cancelTask:b,deleteTask:G,retryTask:Z,loadTaskHistory:U,clearHistory:X,restoreTaskFromStorage:async r=>{try{const s=f.get(`task_${r}`);return s?(e.value=s,s):null}catch(s){return console.error("ä»æœ¬åœ°å­˜å‚¨æ¢å¤ä»»åŠ¡å¤±è´¥:",s),null}},initialize:async()=>{try{await U()}catch(r){console.error("åˆå§‹åŒ–ä»»åŠ¡å­˜å‚¨å¤±è´¥:",r)}},cleanupCurrentTask:x,resetCurrentTask:J}});async function ce(e){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),!0;const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();const a=document.execCommand("copy");return document.body.removeChild(t),a}catch(t){return console.error("å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:",t),!1}}async function ue(){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.readText();throw new Error("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼šéœ€è¦å®‰å…¨ä¸Šä¸‹æ–‡")}catch(e){return console.error("è¯»å–å‰ªè´´æ¿å¤±è´¥:",e),""}}export{w as a,ce as c,ue as r,le as u,C as v};
//# sourceMappingURL=clipboard-de7bf459.js.map
