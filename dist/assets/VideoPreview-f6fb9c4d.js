import{_ as Ce}from"./index-8784b7ea.js";import{f as $,a as te}from"./format-87f85af6.js";import{u as Re,v as oe,c as ze,a as Le}from"./clipboard-de7bf459.js";/* empty css              *//* empty css              *//* empty css              */import{L as Me,K as Ee,r as m,c as y,w as Pe,a as Ue,l as De,B as l,C as i,D as o,j as a,M as d,F,N as se,O as U,P as f,G as p,u as M,Q as Se,R as Be,t as _}from"./vendor-0fdb20b8.js";import{s as n,a as Ne,N as Oe,P as We,B as Ae,T as je,b as Ve,I as Ze,L as Ge}from"./vant-b07c73d6.js";import"./utils-917b1704.js";const He={class:"video-preview-page"},$e={class:"nav-actions"},Fe={class:"page-content"},Qe={key:0,class:"page-loading animate-fade-in"},Ye={class:"loading-content"},Xe={class:"status-section animate-fade-in-up"},Je={class:"status-content"},Ke={class:"status-main"},qe={class:"status-icon"},et={key:1,class:"success-icon"},tt={key:2,class:"error-icon"},ot={key:3,class:"pending-icon"},st={class:"status-text"},at={key:0,class:"progress-section"},lt={class:"progress-info"},nt={class:"progress-text"},rt={class:"status-actions"},it={key:0,class:"video-info-section animate-fade-in-up"},ct={class:"video-card card-floating"},dt={class:"video-thumbnail"},ut={class:"thumbnail-container"},vt={key:0},gt=["src"],ft={key:0,class:"video-fallback"},pt={class:"fallback-content"},_t={class:"fallback-actions"},mt=["src","alt"],yt={class:"play-overlay"},kt={class:"play-button glow-effect"},ht={key:2,class:"duration-badge"},wt={class:"platform-badge"},bt={class:"video-details"},It={class:"video-title"},xt={class:"video-meta"},Tt={class:"meta-row"},Ct={class:"meta-item"},Rt={key:0,class:"meta-item"},zt={class:"meta-row"},Lt={key:0,class:"meta-item"},Mt={key:1,class:"meta-item"},Et={key:0,class:"video-description"},Pt={key:1,class:"video-tags"},Ut={class:"action-section animate-fade-in-up"},Dt={key:0,class:"action-buttons"},St={key:1,class:"processing-info"},Bt={class:"processing-card card-glass"},Nt={key:2,class:"error-info"},Ot={class:"error-card card-floating"},Wt={key:1,class:"transcription-section animate-fade-in-up"},At={class:"transcription-card card-floating"},jt={class:"transcription-header"},Vt={class:"transcription-content"},Zt={class:"text-card original-text"},Gt={class:"text-header"},Ht={class:"text-content"},$t={class:"text-meta"},Ft={key:0,class:"text-card optimized-text"},Qt={class:"text-header"},Yt={class:"text-content"},Xt={class:"transcription-actions"},Jt={key:2,class:"error-section animate-fade-in-up"},ae="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMzYgNzJIMTg0VjEwOEgxMzZWNzJaIiBmaWxsPSIjOUI5QjlCIi8+CjxwYXRoIGQ9Ik0xNTIgODRWOTZMMTY4IDkwTDE1MiA4NFoiIGZpbGw9IndoaXRlIi8+Cjx0ZXh0IHg9IjE2MCIgeT0iMTMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOUI5QjlCIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiPuinhumikea1i+WkseaViTwvdGV4dD4KPC9zdmc+",Kt={__name:"VideoPreview",setup(qt){const le=Me(),Q=Ee(),v=Re(),h=m(le.params.taskId),D=m(!1),E=m(!1),S=m(!1),P=m(!1),B=m(!1),N=m(!1),O=m(!0),z=m(""),k=m(null),C=m(""),R=m(!1),W=m(!1),A=m(null),c=y(()=>v.currentTask),Y=y(()=>v.currentProgress),b=y(()=>v.isProcessing),I=y(()=>v.isCompleted),x=y(()=>v.isFailed),u=y(()=>{var e;return(e=c.value)==null?void 0:e.videoInfo}),X=y(()=>{var e;return(e=c.value)==null?void 0:e.platform}),ne=y(()=>b.value?"解析中":I.value?"解析完成":x.value?"解析失败":"视频预览"),re=y(()=>b.value?"status-processing":I.value?"status-completed":x.value?"status-failed":"status-pending"),ie=y(()=>b.value?"正在解析视频":I.value?"解析完成":x.value?"解析失败":"等待处理"),ce=y(()=>{var e;return b.value?"请耐心等待，正在为您处理视频...":I.value?"视频已准备就绪，您可以下载或转换文案":x.value?((e=c.value)==null?void 0:e.errorMessage)||"处理过程中出现错误，请重试":"任务已创建，即将开始处理"}),de=()=>{Q.back()},j=async()=>{var e;if(h.value){D.value=!0;try{await v.refreshTaskStatus(h.value),((e=c.value)==null?void 0:e.status)==="completed"&&await Z(),n("状态已刷新")}catch(t){console.error("刷新状态失败:",t),n("刷新失败")}finally{D.value=!1}}},J=async()=>{if(c.value){E.value=!0;try{await v.downloadVideo(c.value.taskId),n("下载开始")}catch(e){console.error("下载失败:",e),n("下载失败，请重试")}finally{E.value=!1}}},ue=async()=>{if(c.value){S.value=!0;try{const e=await v.transcribeVideo(c.value.taskId),t=(e==null?void 0:e.transcription)||null;k.value=t,t&&t.status==="completed"&&t.text?n("文案提取完成"):t&&t.status==="processing"?n("文案生成中，请稍候…"):n("暂未获取到文案，稍后重试")}catch(e){console.error("转文案失败:",e),n("转文案失败，请重试")}finally{S.value=!1}}},K=async()=>{if(c.value){P.value=!0;try{await v.retryTask(c.value.taskId),n("重新开始处理")}catch(e){console.error("重试失败:",e),n("重试失败，请稍后再试")}finally{P.value=!1}}},q=async()=>{if(c.value)try{await Ne({title:"确认取消",message:"确定要取消当前任务吗？这将删除已缓存的视频文件，且无法恢复。",confirmButtonText:"确认取消",cancelButtonText:"继续等待",confirmButtonColor:"#ef4444"}),B.value=!0,await v.cancelTask(c.value.taskId),n("任务已取消"),Q.replace("/")}catch(e){e!=="cancel"&&(console.error("取消任务失败:",e),n("取消失败，请重试"))}finally{B.value=!1}},ve=async()=>{var e;if((e=k.value)!=null&&e.text){N.value=!0;try{const t=await v.optimizeText(k.value.text);C.value=t.optimizedText,n("AI优化完成")}catch(t){console.error("AI优化失败:",t),n("AI优化失败，请重试")}finally{N.value=!1}}},V=async e=>{try{await ze(e),n("已复制到剪贴板")}catch{n("复制失败")}},ge=async e=>{if(navigator.share)try{await navigator.share({title:"视频文案",text:e})}catch{V(e)}else V(e)},fe=e=>{try{const t=new Blob([e],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(t),g=document.createElement("a");g.href=s,g.download=`视频文案_${new Date().getTime()}.txt`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(s),n("文案已导出")}catch(t){console.error("导出失败:",t),n("导出失败")}},pe=()=>{z.value=""},Z=async()=>{if(h.value)try{console.log("加载预览信息...");const e=await Le.getVideoPreview(h.value);console.log("预览信息响应:",e),c.value&&e&&e.data&&(console.log("预览URL:",e.data.previewUrl),v.currentTask&&(v.currentTask.previewUrl=e.data.previewUrl,v.currentTask.downloadUrl=e.data.downloadUrl,v.currentTask.fileInfo=e.data.fileInfo,console.log("已直接更新taskStore.currentTask")),console.log("更新后的任务信息:",c.value))}catch(e){console.error("加载预览信息失败:",e)}},_e=()=>{var s,g,w,T,r;const e=((s=c.value)==null?void 0:s.previewUrl)||((w=(g=c.value)==null?void 0:g.videoInfo)==null?void 0:w.previewUrl),t=(r=(T=c.value)==null?void 0:T.videoInfo)==null?void 0:r.thumbnail;return console.log("获取预览图片:",{previewUrl:e,thumbnail:t,currentTask:c.value}),e||t||ae},G=y(()=>{var t;const e=(t=c.value)==null?void 0:t.previewUrl;if(!e)return null;console.log("=== 视频URL处理调试 ==="),console.log("原始预览URL:",e),console.log("当前环境:","生产环境");{let s=e;if(e.startsWith("http://47.109.155.18:2222/"))s=e.replace("http://47.109.155.18:2222","");else if(e.startsWith("http://")||e.startsWith("https://"))try{s=new URL(e).pathname}catch(g){return console.error("URL解析失败:",g),null}return s.startsWith("/videos/")||(s.startsWith("/")?s.includes("/videos/")&&(s=s.substring(s.indexOf("/videos/"))):s=`/videos/${s}`),console.log("生产环境 - 转换为代理URL:",s),console.log("视频将通过Netlify代理访问:",window.location.origin+s),s}}),me=e=>{e.target.src.includes("placeholder-video.jpg")||e.target.src.includes("data:image/svg+xml")||e.target.dataset.errorHandled||(e.target.dataset.errorHandled="true",e.target.src=ae)},ye=e=>{console.log("=== 视频开始加载 ==="),console.log("视频URL:",e.target.src),console.log("加载时间:",new Date().toISOString())},ke=e=>{console.log("=== 视频元数据加载完成 ==="),console.log("视频时长:",e.target.duration),console.log("视频尺寸:",`${e.target.videoWidth}x${e.target.videoHeight}`),console.log("网络状态:",e.target.networkState),console.log("就绪状态:",e.target.readyState)},he=e=>{console.log("=== 视频可以开始播放 ==="),console.log("缓冲状态:",e.target.buffered.length>0?`${e.target.buffered.end(0)}s`:"0s"),console.log("✅ 视频加载成功"),R.value=!1},we=e=>{var T;console.error("=== 视频加载失败调试 ==="),console.error("视频URL:",e.target.src),console.error("错误事件:",e),console.error("错误详情:",e.target.error),console.error("视频networkState:",e.target.networkState),console.error("视频readyState:",e.target.readyState);const t={1:"MEDIA_ERR_ABORTED - 用户终止了视频加载",2:"MEDIA_ERR_NETWORK - 网络错误导致视频下载失败",3:"MEDIA_ERR_DECODE - 视频解码失败",4:"MEDIA_ERR_SRC_NOT_SUPPORTED - 视频格式不支持或文件不存在"},s=(T=e.target.error)==null?void 0:T.code,g=t[s]||"未知错误";console.error("错误类型:",g);const w=e.target.src;console.log("尝试验证视频URL可访问性:",w),fetch(w,{method:"HEAD",mode:"cors",credentials:"omit"}).then(r=>{console.log("视频文件HTTP状态:",r.status),console.log("视频文件Content-Type:",r.headers.get("Content-Type")),console.log("视频文件Content-Length:",r.headers.get("Content-Length")),console.log("视频文件响应头:",Object.fromEntries(r.headers.entries())),r.status===200?(console.log("✅ 视频文件可访问，可能是格式或编码问题"),n("视频文件可访问但无法播放，可能是格式不兼容")):(console.log("❌ 视频文件HTTP状态异常"),n(`视频文件访问失败 (状态码: ${r.status})`))}).catch(r=>{console.error("视频文件访问失败:",r),r.name==="TypeError"&&r.message.includes("CORS")?(console.error("❌ CORS跨域问题"),n("视频访问被跨域策略阻止，请检查代理配置")):r.name==="TypeError"&&r.message.includes("Failed to fetch")?(console.error("❌ 网络请求失败"),n("无法访问视频文件，请检查网络连接或代理配置")):(console.error("❌ 其他网络错误"),n("视频加载失败，请检查网络连接或稍后重试"))}),s===4?n("视频格式不支持或文件不存在"):s===2?n("网络错误，无法下载视频"):n(`视频加载失败: ${g}`),R.value=!0},be=async()=>{if(!(!A.value||!h.value)){W.value=!0,R.value=!1;try{await Z(),A.value.load(),n("正在重新加载视频...")}catch(e){console.error("重新加载视频失败:",e),n("重新加载失败，请稍后重试"),R.value=!0}finally{W.value=!1}}},Ie=e=>({douyin:"抖音",bilibili:"哔哩哔哩",youtube:"YouTube",tiktok:"TikTok",upload:"文件上传"})[e]||e,xe=e=>({douyin:"#ff0050",bilibili:"#00a1d6",youtube:"#ff0000",tiktok:"#000000",upload:"#667eea"})[e]||"#667eea";return Pe(G,e=>{e&&(R.value=!1,console.log("预览URL已更新:",e))}),Ue(async()=>{var e;if(console.log("VideoPreview mounted, taskId:",h.value),h.value){oe.setCurrentTask(h.value);try{const t=await v.restoreTaskFromStorage(h.value);console.log("恢复的任务:",t),((e=c.value)==null?void 0:e.status)==="completed"&&(console.log("任务已完成，立即加载预览信息"),Z().catch(s=>{console.error("后台加载预览信息失败:",s)})),!c.value||!c.value.taskId?(console.log("没有当前任务，需要刷新状态"),await j()):(console.log("已有任务数据，跳过状态刷新"),c.value.status!=="completed"&&(console.log("任务未完成，后台刷新状态"),j().catch(s=>{console.error("后台刷新状态失败:",s)})))}catch(t){console.error("初始化任务失败:",t),z.value="加载任务失败，请刷新页面重试"}finally{O.value=!1}}else z.value="无效的任务ID",O.value=!1}),De(()=>{oe.setShouldCleanOnUnload(!1)}),(e,t)=>{var ee;const s=Ze,g=Oe,w=Ge,T=We,r=Ae,H=je,Te=Ve;return l(),i("div",He,[t[27]||(t[27]=o("div",{class:"bg-decoration"},[o("div",{class:"decoration-circle circle-1"}),o("div",{class:"decoration-circle circle-2"})],-1)),a(g,{title:ne.value,"left-arrow":"",fixed:"",placeholder:"",class:"nav-bar glass-nav",onClickLeft:de},{right:d(()=>[o("div",$e,[a(s,{name:"replay",size:"18",onClick:j,class:se([{spinning:D.value},"nav-action-btn"])},null,8,["class"]),a(s,{name:"delete-o",size:"18",onClick:q,class:"nav-action-btn cancel-btn"})])]),_:1},8,["title"]),o("div",Fe,[O.value?(l(),i("div",Qe,[o("div",Ye,[a(w,{size:"40px",color:"#667eea"}),t[3]||(t[3]=o("p",{class:"loading-text"},"正在加载视频信息...",-1))])])):(l(),i(F,{key:1},[o("div",Xe,[o("div",{class:se(["status-card card-floating",re.value])},[o("div",Je,[o("div",Ke,[o("div",qe,[b.value?(l(),U(w,{key:0,size:"32px",color:"white"})):I.value?(l(),i("div",et,[a(s,{name:"checked",size:"32px"})])):x.value?(l(),i("div",tt,[a(s,{name:"close",size:"32px"})])):(l(),i("div",ot,[a(s,{name:"clock",size:"32px"})]))]),o("div",st,[o("h3",null,f(ie.value),1),o("p",null,f(ce.value),1)])]),b.value?(l(),i("div",at,[a(T,{percentage:Y.value,"stroke-width":"8",color:"rgba(255,255,255,0.9)","track-color":"rgba(255,255,255,0.2)",class:"progress-bar"},null,8,["percentage"]),o("div",lt,[o("span",nt,f(Y.value)+"%",1),t[4]||(t[4]=o("span",{class:"progress-detail"},"正在处理视频...",-1))])])):p("",!0),o("div",rt,[I.value?p("",!0):(l(),U(r,{key:0,size:"small",type:"danger",class:"btn-glass",onClick:q,loading:B.value},{icon:d(()=>[a(s,{name:"cross"})]),default:d(()=>[t[5]||(t[5]=_(" 取消任务 "))]),_:1,__:[5]},8,["loading"])),x.value?(l(),U(r,{key:1,size:"small",type:"primary",class:"btn-glass",onClick:K,loading:P.value},{icon:d(()=>[a(s,{name:"replay"})]),default:d(()=>[t[6]||(t[6]=_(" 重新尝试 "))]),_:1,__:[6]},8,["loading"])):p("",!0)])])],2)]),u.value?(l(),i("div",it,[o("div",ct,[o("div",dt,[o("div",ut,[G.value?(l(),i("div",vt,[o("video",{ref_key:"videoPlayer",ref:A,src:G.value,controls:"",preload:"metadata",crossorigin:"anonymous",playsinline:"",class:"video-player",onError:we,onLoadstart:ye,onLoadedmetadata:ke,onCanplay:he}," 您的浏览器不支持视频播放 ",40,gt),R.value?(l(),i("div",ft,[o("div",pt,[a(s,{name:"warning-o",size:"48",color:"#f59e0b"}),t[9]||(t[9]=o("h4",null,"视频无法播放",-1)),t[10]||(t[10]=o("p",null,"视频文件可能正在处理中或存在格式问题",-1)),o("div",_t,[a(r,{type:"primary",size:"small",onClick:be,loading:W.value},{default:d(()=>t[7]||(t[7]=[_(" 重新加载 ")])),_:1,__:[7]},8,["loading"]),a(r,{type:"default",size:"small",onClick:J,loading:E.value},{default:d(()=>t[8]||(t[8]=[_(" 直接下载 ")])),_:1,__:[8]},8,["loading"])])])])):p("",!0)])):(l(),i(F,{key:1},[o("img",{src:_e(),alt:((ee=u.value)==null?void 0:ee.title)||"视频预览",onError:me,class:"thumbnail-image"},null,40,mt),o("div",yt,[o("div",kt,[a(s,{name:"play-circle",size:"64px"})])])],64)),u.value.duration?(l(),i("div",ht,f(M($)(u.value.duration)),1)):p("",!0),o("div",wt,[o("span",{style:Se({color:xe(X.value)})},f(Ie(X.value)),5)])])]),o("div",bt,[o("h2",It,f(u.value.title||"解析中..."),1),o("div",xt,[o("div",Tt,[o("div",Ct,[a(s,{name:"user-o"}),o("span",null,f(u.value.author||"未知作者"),1)]),u.value.viewCount?(l(),i("div",Rt,[a(s,{name:"eye-o"}),o("span",null,f(M(te)(u.value.viewCount))+" 次播放",1)])):p("",!0)]),o("div",zt,[u.value.likeCount?(l(),i("div",Lt,[a(s,{name:"like-o"}),o("span",null,f(M(te)(u.value.likeCount))+" 点赞",1)])):p("",!0),u.value.duration?(l(),i("div",Mt,[a(s,{name:"clock-o"}),o("span",null,f(M($)(u.value.duration)),1)])):p("",!0)])]),u.value.description?(l(),i("div",Et,[t[11]||(t[11]=o("h4",null,"视频描述",-1)),o("p",null,f(u.value.description),1)])):p("",!0),u.value.tags&&u.value.tags.length?(l(),i("div",Pt,[(l(!0),i(F,null,Be(u.value.tags.slice(0,5),L=>(l(),U(H,{key:L,size:"mini",class:"tag-item"},{default:d(()=>[_(f(L),1)]),_:2},1024))),128))])):p("",!0)])])])):p("",!0),o("div",Ut,[I.value?(l(),i("div",Dt,[a(r,{type:"primary",size:"large",class:"action-btn download-btn btn-primary",onClick:J,loading:E.value},{icon:d(()=>[a(s,{name:"down"})]),default:d(()=>[t[12]||(t[12]=_(" 下载视频 "))]),_:1,__:[12]},8,["loading"]),a(r,{type:"success",size:"large",class:"action-btn transcribe-btn btn-accent",onClick:ue,loading:S.value},{icon:d(()=>[a(s,{name:"volume-o"})]),default:d(()=>[t[13]||(t[13]=_(" 转换文案 "))]),_:1,__:[13]},8,["loading"])])):b.value?(l(),i("div",St,[o("div",Bt,[a(w,{size:"24px",color:"#667eea"}),t[14]||(t[14]=o("span",null,"正在处理视频，请耐心等待...",-1))])])):x.value?(l(),i("div",Nt,[o("div",Ot,[a(s,{name:"warning-o",size:"24px",color:"#ef4444"}),t[16]||(t[16]=o("span",null,"处理失败，请重试或返回重新选择视频",-1)),a(r,{type:"warning",size:"small",onClick:K,loading:P.value},{default:d(()=>t[15]||(t[15]=[_(" 重新尝试 ")])),_:1,__:[15]},8,["loading"])])])):p("",!0)]),k.value?(l(),i("div",Wt,[o("div",At,[o("div",jt,[o("h3",null,[a(s,{name:"chat-o"}),t[17]||(t[17]=_(" 提取的文案 "))]),a(r,{size:"small",type:"primary",class:"btn-glass",onClick:ve,loading:N.value},{default:d(()=>[a(s,{name:"fire"}),t[18]||(t[18]=_(" AI优化 "))]),_:1,__:[18]},8,["loading"])]),o("div",Vt,[o("div",Zt,[o("div",Gt,[t[20]||(t[20]=o("h4",null,"原始文案",-1)),a(H,{size:"mini",color:"#f3f4f6","text-color":"#6b7280"},{default:d(()=>t[19]||(t[19]=[_("原始")])),_:1,__:[19]})]),o("div",Ht,[o("p",null,f(k.value.text),1),o("div",$t,[o("span",null,"时长: "+f(M($)(k.value.duration)),1),o("span",null,f(k.value.createTime|e.formatDate),1)])])]),C.value?(l(),i("div",Ft,[o("div",Qt,[t[22]||(t[22]=o("h4",null,"AI优化文案",-1)),a(H,{size:"mini",type:"success"},{default:d(()=>t[21]||(t[21]=[_("优化")])),_:1,__:[21]})]),o("div",Yt,[o("p",null,f(C.value),1),t[23]||(t[23]=o("div",{class:"text-meta"},[o("span",null,"由AI智能优化")],-1))])])):p("",!0)]),o("div",Xt,[a(r,{class:"btn-glass",onClick:t[0]||(t[0]=L=>V(C.value||k.value.text))},{icon:d(()=>[a(s,{name:"copy"})]),default:d(()=>[t[24]||(t[24]=_(" 复制文案 "))]),_:1,__:[24]}),a(r,{class:"btn-glass",onClick:t[1]||(t[1]=L=>ge(C.value||k.value.text))},{icon:d(()=>[a(s,{name:"share"})]),default:d(()=>[t[25]||(t[25]=_(" 分享 "))]),_:1,__:[25]}),a(r,{class:"btn-glass",onClick:t[2]||(t[2]=L=>fe(C.value||k.value.text))},{icon:d(()=>[a(s,{name:"down"})]),default:d(()=>[t[26]||(t[26]=_(" 导出 "))]),_:1,__:[26]})])])])):p("",!0),z.value?(l(),i("div",Jt,[a(Te,{type:"danger",text:z.value,"left-icon":"warning-o",onClick:pe,class:"error-notice"},null,8,["text"])])):p("",!0)],64))])])}}},co=Ce(Kt,[["__scopeId","data-v-6090c93a"]]);export{co as default};
//# sourceMappingURL=VideoPreview-f6fb9c4d.js.map
