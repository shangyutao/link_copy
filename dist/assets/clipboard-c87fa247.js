import{S as q,r as f,c as m}from"./vendor-0fdb20b8.js";import{a as W}from"./utils-917b1704.js";import{c as X,d as b,s as D}from"./vant-b07c73d6.js";const Q=!1,N="/api";console.log("API环境配置:",{isDevelopment:Q,API_BASE_URL:N});const c=W.create({baseURL:N,timeout:3e4,headers:{"Content-Type":"application/json"}});c.interceptors.request.use(e=>{var t;return e.showLoading!==!1&&X({message:"请求中...",forbidClick:!0,duration:0}),console.log("API请求:",(t=e.method)==null?void 0:t.toUpperCase(),e.url,e.data),e},e=>(b(),console.error("请求错误:",e),Promise.reject(e)));c.interceptors.response.use(e=>{b();const{data:t}=e;if(console.log("API响应:",e.config.url,t),t.code&&t.code!==200){const a=t.message||"请求失败";return D({type:"fail",message:a}),Promise.reject(new Error(a))}return t},e=>{b(),console.error("响应错误:",e);let t="网络错误，请稍后重试";if(e.response){const{status:a,data:i}=e.response;switch(a){case 400:t=i.message||"请求参数错误";break;case 401:t="未授权，请重新登录";break;case 403:t="没有权限访问";break;case 404:t="请求的资源不存在";break;case 408:t="请求超时";break;case 500:t="服务器内部错误";break;case 503:t="服务暂时不可用";break;default:i&&i.message&&(t=i.message)}}else e.code==="ECONNABORTED"?t="请求超时，请检查网络连接":e.message==="Network Error"&&(t="网络连接异常");return D({type:"fail",message:t}),Promise.reject(e)});const h={async createDownloadTask(e,t=null){return(await c.post("/video/download",{url:e,platform:t})).data},async uploadVideoFile(e,t=null){var w;if(!e||!(e instanceof File))throw new Error("请选择有效的视频文件");const a=500*1024*1024;if(e.size>a)throw new Error(`文件大小不能超过500MB，当前文件大小：${this.formatFileSize(e.size)}`);const i=["video/mp4","video/avi","video/quicktime","video/x-msvideo","video/x-flv","video/webm","video/x-matroska","video/mp4v-es","video/3gpp","video/ogg"],d=[".mp4",".avi",".mov",".wmv",".flv",".webm",".mkv",".m4v",".3gp",".ogv"],l=e.name.toLowerCase().substring(e.name.lastIndexOf("."));if(!i.includes(e.type)&&!d.includes(l))throw new Error("不支持的视频格式，请上传 MP4、AVI、MOV、WMV、FLV、WEBM、MKV、M4V、3GP、OGV 格式的视频文件");const v=new FormData;v.append("video",e);const u={headers:{"Content-Type":"multipart/form-data"},timeout:3e5,onUploadProgress:n=>{if(t&&n.total){const p=Math.round(n.loaded*100/n.total);t(p)}}};try{return(await c.post("/video/upload",v,u)).data}catch(n){throw n.code==="ECONNABORTED"?new Error("上传超时，请检查网络连接或尝试上传更小的文件"):((w=n.response)==null?void 0:w.status)===413?new Error("文件过大，请上传小于500MB的视频文件"):n}},async getTaskStatus(e){return(await c.get(`/video/status/${e}`,{showLoading:!1})).data},async getDownloadUrl(e){return`${c.defaults.baseURL}/video/file/${e}`},async cleanVideo(e){return(await c.delete(`/video/clean/${e}`,{showLoading:!1})).data},async deleteTask(e){return this.cleanVideo(e)},async getSupportedPlatforms(){return(await c.get("/video/platforms")).data},async getTaskList(e={}){return(await c.get("/video/tasks",{params:e})).data},async getStats(){return(await c.get("/video/stats")).data},async cleanExpiredFiles(e=24){return(await c.post("/video/clean/expired",{hours:e})).data},async retryTask(e){return(await c.post(`/video/retry/${e}`)).data},async getVideoPreview(e){return await c.get(`/video/preview/${e}`)},async transcribeVideo(e){return(await c.post(`/video/transcribe/${e}`)).data},async optimizeText(e,t={}){var v;if(!e||typeof e!="string")throw new Error("文案内容不能为空");const a=e.trim();if(a.length===0)throw new Error("文案内容不能为空");const i=1e4;if(a.length>i)throw new Error(`文案长度不能超过${i}字符，当前长度：${a.length}`);const d=t.timeout||12e4,l=1500;if(a.length>l)return await this._optimizeTextInChunks(a,d);try{return(await c.post("/video/optimize-text",{text:a},{timeout:d,showLoading:t.showLoading!==!1})).data}catch(u){throw u.code==="ECONNABORTED"||((v=u.response)==null?void 0:v.status)===408?new Error("AI优化请求超时，建议将长文案分段提交"):u}},async _optimizeTextInChunks(e,t){const i=[],d=e.split(/([。！？\.\!\?]+)/);let l="";for(let n=0;n<d.length;n++){const p=d[n];l.length+p.length<=1500?l+=p:(l.trim()&&i.push(l.trim()),l=p)}if(l.trim()&&i.push(l.trim()),i.length===1&&i[0].length>1500){i.length=0;for(let n=0;n<e.length;n+=1500)i.push(e.slice(n,n+1500))}console.log(`文案分为${i.length}段进行优化`);const v=[],u=[];for(let n=0;n<i.length;n++)try{console.log(`正在优化第${n+1}/${i.length}段...`);const p=await c.post("/video/optimize-text",{text:i[n]},{timeout:t,showLoading:!1});v.push(p.data.optimizedText||i[n]),n<i.length-1&&await new Promise(S=>setTimeout(S,1e3))}catch(p){console.error(`第${n+1}段优化失败:`,p),u.push(`第${n+1}段: ${p.message}`),v.push(i[n])}const w=v.join("");return{originalText:e,optimizedText:w,optimizationTime:new Date().toISOString(),model:"doubao-seed-1-6-250615",chunks:i.length,errors:u.length>0?u:void 0}},async getTranscriptionResult(e){return(await c.get(`/video/transcription/${e}`,{showLoading:!1})).data}};class Y{constructor(){this.currentTaskId=null,this.shouldCleanOnUnload=!0,this.setupCleanupListeners()}setCurrentTask(t){this.currentTaskId&&this.currentTaskId!==t&&this.cleanTask(this.currentTaskId),this.currentTaskId=t}async cleanTask(t){if(t)try{await h.cleanVideo(t),console.log(`已清理视频缓存: ${t}`)}catch(a){console.warn(`清理视频缓存失败: ${t}`,a)}}async cleanCurrentTask(){this.currentTaskId&&(await this.cleanTask(this.currentTaskId),this.currentTaskId=null)}setShouldCleanOnUnload(t){this.shouldCleanOnUnload=t}setupCleanupListeners(){window.addEventListener("beforeunload",()=>{if(this.shouldCleanOnUnload&&this.currentTaskId){const t=`${c.defaults.baseURL}/video/clean/${this.currentTaskId}`;navigator.sendBeacon(t,JSON.stringify({method:"DELETE"}))}}),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"&&this.shouldCleanOnUnload&&this.currentTaskId){const t=`${c.defaults.baseURL}/video/clean/${this.currentTaskId}`;navigator.sendBeacon(t,JSON.stringify({method:"DELETE"}))}}),window.addEventListener("pagehide",()=>{if(this.shouldCleanOnUnload&&this.currentTaskId){const t=`${c.defaults.baseURL}/video/clean/${this.currentTaskId}`;navigator.sendBeacon(t,JSON.stringify({method:"DELETE"}))}})}}const k=new Y,g={get(e,t=null){try{const a=localStorage.getItem(e);return a?JSON.parse(a):t}catch(a){return console.error("读取本地存储失败:",a),t}},set(e,t){try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(a){return console.error("保存到本地存储失败:",a),!1}},remove(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("删除本地存储失败:",t),!1}},clear(){try{return localStorage.clear(),!0}catch(e){return console.error("清空本地存储失败:",e),!1}},getSize(){try{let e=0;for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=localStorage[t].length+t.length);return e}catch(e){return console.error("计算存储大小失败:",e),0}}},ae=q("task",()=>{const e=f(null),t=f([]),a=f(!1),i=f(!1),d=f(null),l=f(null),v=m(()=>{var r;return((r=e.value)==null?void 0:r.progress)||0}),u=m(()=>{var s;const r=(s=e.value)==null?void 0:s.status;return r==="pending"||r==="downloading"}),w=m(()=>{var r;return((r=e.value)==null?void 0:r.status)==="completed"}),n=m(()=>{var r;return((r=e.value)==null?void 0:r.status)==="failed"}),p=m(()=>{var r;return((r=l.value)==null?void 0:r.status)==="processing"}),S=m(()=>{var r;return((r=l.value)==null?void 0:r.status)==="completed"}),z=m(()=>{var r;return((r=l.value)==null?void 0:r.status)==="failed"}),H=async(r,s=null)=>{a.value=!0;try{await E();const o=await h.createDownloadTask(r,s);return e.value={taskId:o.taskId,originalUrl:r,platform:o.platform,status:o.status,progress:0,createTime:o.createTime,isExisting:o.isExisting},k.setCurrentTask(o.taskId),await T(e.value),x(e.value),u.value&&I(o.taskId),o}catch(o){throw console.error("创建任务失败:",o),o}finally{a.value=!1}},P=async(r,s=null)=>{a.value=!0;try{await E();const o=await h.uploadVideoFile(r,s);e.value={taskId:o.taskId,originalFile:r,fileName:r.name,fileSize:r.size,platform:"upload",status:o.status,progress:0,createTime:o.createTime||new Date().toISOString(),isExisting:o.isExisting||!1},k.setCurrentTask(o.taskId);const L={...e.value,originalFile:null};return await T(L),x(L),u.value&&I(o.taskId),o}catch(o){throw console.error("创建上传任务失败:",o),o}finally{a.value=!1}},C=async r=>{try{const s=await h.getTaskStatus(r);console.log("API返回的任务状态:",s);const o=s.data||s;return console.log("提取的任务数据:",o),console.log("任务进度:",o.progress),e.value&&e.value.taskId===r?(e.value={...e.value,...o,updateTime:new Date().toISOString()},console.log("更新后的任务状态:",e.value),await T(e.value),U(e.value)):e.value||(e.value={...o,updateTime:new Date().toISOString()},console.log("创建的当前任务:",e.value),await T(e.value),x(e.value)),s}catch(s){throw console.error("刷新任务状态失败:",s),s}},V=async()=>{var r;if((r=e.value)!=null&&r.taskId)return await C(e.value.taskId)},F=r=>{e.value&&(e.value={...e.value,...r,updateTime:new Date().toISOString()},T(e.value),U(e.value))},I=r=>{y(),d.value=setInterval(async()=>{try{await C(r),u.value||y()}catch(s){console.error("轮询任务状态失败:",s),y()}},5e3)},y=()=>{d.value&&(clearInterval(d.value),d.value=null)},A=async r=>{i.value=!0;try{const s=await h.getDownloadUrl(r),o=document.createElement("a");return o.href=s,o.download=`video_${r}.mp4`,document.body.appendChild(o),o.click(),document.body.removeChild(o),!0}catch(s){throw console.error("下载视频失败:",s),s}finally{i.value=!1}},_=async r=>{try{l.value={taskId:r,status:"processing",progress:0,createTime:new Date().toISOString()};const s=await h.transcribeVideo(r);return l.value={...l.value,...s,status:"completed"},s}catch(s){throw l.value&&(l.value.status="failed",l.value.errorMessage=s.message),console.error("转换视频为文案失败:",s),s}},M=async r=>{try{const s=await h.getTranscriptionResult(r);return l.value={...l.value,...s.transcription,videoInfo:s.videoInfo},s}catch(s){throw console.error("获取转文案结果失败:",s),s}},R=async(r,s={})=>{try{return await h.optimizeText(r,s)}catch(o){throw console.error("AI优化文案失败:",o),o}},E=async()=>{if(e.value)try{await k.cleanCurrentTask(),console.log("已清理当前任务缓存")}catch(r){console.warn("清理当前任务失败:",r)}},O=async r=>{try{return await h.cleanVideo(r),e.value&&e.value.taskId===r&&(e.value=null,k.setCurrentTask(null),y()),J(r),await G(r),!0}catch(s){throw console.error("取消任务失败:",s),s}},B=async r=>O(r),K=async r=>{try{const s=await h.retryTask(r);return e.value&&e.value.taskId===r&&(e.value.status="pending",I(r)),s}catch(s){throw console.error("重试任务失败:",s),s}},Z=()=>{e.value=null,l.value=null,y(),k.setCurrentTask(null)},$=async()=>{try{const r=g.get("taskHistory",[]);return t.value=r,r}catch(r){return console.error("加载任务历史失败:",r),[]}},j=async()=>{try{return t.value=[],g.remove("taskHistory"),!0}catch(r){throw console.error("清除历史记录失败:",r),r}},x=r=>{const s=t.value.findIndex(o=>o.taskId===r.taskId);s>=0?t.value[s]={...r,updateTime:new Date().toISOString()}:(t.value.unshift({...r,updateTime:new Date().toISOString()}),t.value.length>50&&(t.value=t.value.slice(0,50))),g.set("taskHistory",t.value)},U=r=>{const s=t.value.findIndex(o=>o.taskId===r.taskId);s>=0&&(t.value[s]={...r,updateTime:new Date().toISOString()},g.set("taskHistory",t.value))},J=r=>{t.value=t.value.filter(s=>s.taskId!==r),g.set("taskHistory",t.value)},T=async r=>{try{g.set(`task_${r.taskId}`,r)}catch(s){console.error("保存任务到本地存储失败:",s)}},G=async r=>{try{g.remove(`task_${r}`)}catch(s){console.error("从本地存储移除任务失败:",s)}};return{currentTask:e,taskHistory:t,isLoading:a,isDownloading:i,transcriptionData:l,currentProgress:v,isProcessing:u,isCompleted:w,isFailed:n,isTranscribing:p,isTranscriptionCompleted:S,isTranscriptionFailed:z,createTask:H,createUploadTask:P,refreshTaskStatus:C,updateTaskStatus:V,updateCurrentTask:F,startPolling:I,stopPolling:y,downloadVideo:A,transcribeVideo:_,getTranscriptionResult:M,optimizeText:R,cancelTask:O,deleteTask:B,retryTask:K,loadTaskHistory:$,clearHistory:j,restoreTaskFromStorage:async r=>{try{const s=g.get(`task_${r}`);return s?(e.value=s,s):null}catch(s){return console.error("从本地存储恢复任务失败:",s),null}},initialize:async()=>{try{await $()}catch(r){console.error("初始化任务存储失败:",r)}},cleanupCurrentTask:E,resetCurrentTask:Z}});async function ne(e){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),!0;const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();const a=document.execCommand("copy");return document.body.removeChild(t),a}catch(t){return console.error("复制到剪贴板失败:",t),!1}}async function ie(){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.readText();throw new Error("无法读取剪贴板：需要安全上下文")}catch(e){return console.error("读取剪贴板失败:",e),""}}export{h as a,ne as c,ie as r,ae as u,k as v};
//# sourceMappingURL=clipboard-c87fa247.js.map
